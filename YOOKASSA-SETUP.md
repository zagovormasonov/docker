# Настройка интеграции с Юкассой

## 1. Получение данных от Юкассы

1. Зарегистрируйтесь в [Юкассе](https://yookassa.ru/)
2. Создайте магазин в личном кабинете
3. Получите следующие данные:
   - **Shop ID** (ID магазина)
   - **Secret Key** (Секретный ключ)

## 2. Настройка переменных окружения

Добавьте в файл `.env` в корне проекта:

```env
# Юкасса
YOOKASSA_SHOP_ID=ваш_shop_id
YOOKASSA_SECRET_KEY=ваш_secret_key
FRONTEND_URL=http://localhost:3000
```

## 3. Создание таблицы платежей

Выполните SQL скрипт для создания таблицы платежей:

```bash
psql -d your_database -f CREATE-PAYMENTS-TABLE.sql
```

## 4. Настройка webhook в Юкассе

1. В личном кабинете Юкассы перейдите в раздел "Настройки" → "Webhook"
2. Добавьте URL для уведомлений: `https://your-domain.com/api/payments/webhook`
3. Выберите события: `payment.succeeded`

## 5. Тестирование

### Тестовые карты Юкассы:
- **Успешная оплата**: 5555 5555 5555 4444
- **Недостаточно средств**: 5555 5555 5555 4477
- **Отклоненная карта**: 5555 5555 5555 4457

### Тестовые данные:
- **CVV**: 123
- **Срок действия**: любая будущая дата
- **Имя держателя**: любое

## 6. Структура платежей

### Тарифные планы:
- `free` - Бесплатный пробный период
- `yearly` - Эксперт на год (990 ₽)
- `lifetime` - Пожизненный доступ (3369 ₽)

### Статусы платежей:
- `pending` - Ожидает оплаты
- `succeeded` - Успешно оплачен
- `failed` - Ошибка оплаты
- `canceled` - Отменен

## 7. API Endpoints

### Создание платежа
```
POST /api/payments/create
Authorization: Bearer <token>
Content-Type: application/json

{
  "planId": "yearly",
  "amount": 990,
  "description": "Подписка Эксперт на год"
}
```

### Проверка статуса платежа
```
GET /api/payments/status/:paymentId
Authorization: Bearer <token>
```

### Webhook (для Юкассы)
```
POST /api/payments/webhook
Content-Type: application/json
```

## 8. Безопасность

- Все API endpoints защищены JWT токенами
- Webhook проверяет подлинность уведомлений от Юкассы
- Платежи привязываются к конкретному пользователю
- Дублирование платежей предотвращается через idempotence key

## 9. Мониторинг

Логи платежей сохраняются в таблице `payments`:
- Время создания и обновления
- Статус платежа
- Связь с пользователем
- ID платежа в Юкассе

## 10. Обработка ошибок

Система обрабатывает следующие ошибки:
- Недостаточно средств на карте
- Отклоненная карта
- Технические ошибки Юкассы
- Ошибки сети
- Дублирование платежей

