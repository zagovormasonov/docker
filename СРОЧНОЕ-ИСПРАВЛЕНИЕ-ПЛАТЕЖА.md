# üö® –°–†–û–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—Ç–∞–ª —ç–∫—Å–ø–µ—Ä—Ç–æ–º –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

## ‚ö° –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ü–†–Ø–ú–û –°–ï–ô–ß–ê–° (3 –º–∏–Ω—É—Ç—ã)

### –®–∞–≥ 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (1 –º–∏–Ω—É—Ç–∞)

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ PostgreSQL:

```bash
psql -d –≤–∞—à–∞_–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö -f –°–†–û–ß–ù–ê–Ø-–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê-–ü–õ–ê–¢–ï–ñ–ê.sql
```

–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ pgAdmin –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ.

**–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç:**
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–ª–∞—Ç–µ–∂–µ–π
- –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—Ç–∞–ª —ç–∫—Å–ø–µ—Ä—Ç–æ–º)
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

### –®–∞–≥ 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é (1 –º–∏–Ω—É—Ç–∞)

#### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ï—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ `–ò–°–ü–†–ê–í–ò–¢–¨-–ö–û–ù–ö–†–ï–¢–ù–´–ô-–ü–õ–ê–¢–ï–ñ.sql`
2. –ù–∞–π–¥–∏—Ç–µ –±–ª–æ–∫ **"–í–ê–†–ò–ê–ù–¢ 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"** (—Å—Ç—Ä–æ–∫–∞ ~120)
3. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –±–ª–æ–∫ (—É–¥–∞–ª–∏—Ç–µ `/*` –∏ `*/`)
4. –ó–∞–º–µ–Ω–∏—Ç–µ `'user@example.com'` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π email
5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç

#### –í–∞—Ä–∏–∞–Ω—Ç –ë: –ï—Å–ª–∏ –∑–Ω–∞–µ—Ç–µ ID –ø–ª–∞—Ç–µ–∂–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ `–ò–°–ü–†–ê–í–ò–¢–¨-–ö–û–ù–ö–†–ï–¢–ù–´–ô-–ü–õ–ê–¢–ï–ñ.sql`
2. –ù–∞–π–¥–∏—Ç–µ –±–ª–æ–∫ **"–í–ê–†–ò–ê–ù–¢ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ ID –ø–ª–∞—Ç–µ–∂–∞"** (—Å—Ç—Ä–æ–∫–∞ ~30)
3. –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –±–ª–æ–∫ (—É–¥–∞–ª–∏—Ç–µ `/*` –∏ `*/`)
4. –ó–∞–º–µ–Ω–∏—Ç–µ `123` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –ø–ª–∞—Ç–µ–∂–∞
5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ backend (1 –º–∏–Ω—É—Ç–∞)

```bash
# –°–º–æ—Ç—Ä–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
docker logs --tail 100 synergy_backend | grep -i "webhook\|–ø–ª–∞—Ç–µ–∂\|payment"
```

**–ò—â–µ–º:**
- `üì• –ü–æ–ª—É—á–µ–Ω webhook –æ—Ç –Æ–∫–∞—Å—Å—ã` - –ø—Ä–∏—Ö–æ–¥–∏—Ç –ª–∏ webhook?
- `‚ùå` - –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏?
- `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ... —Å—Ç–∞–ª —ç–∫—Å–ø–µ—Ä—Ç–æ–º` - –±—ã–ª –ª–∏ —É—Å–ø–µ—Ö?

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç –Æ–∫–∞—Å—Å—ã

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç `üì• –ü–æ–ª—É—á–µ–Ω webhook –æ—Ç –Æ–∫–∞—Å—Å—ã`
- –ü–ª–∞—Ç–µ–∂ –≤ —Å—Ç–∞—Ç—É—Å–µ `pending` –≤ –±–∞–∑–µ

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ –Æ–∫–∞—Å—Å–µ:**
   - –í–æ–π–¥–∏—Ç–µ –Ω–∞ [yookassa.ru](https://yookassa.ru/)
   - **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **Webhook**
   - URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/api/payments/webhook`
   - –°–æ–±—ã—Ç–∏–µ `payment.succeeded` –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–æ ‚úÖ

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å URL:**
   ```bash
   curl -X POST https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/api/payments/webhook
   ```
   –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç (–ª—é–±–æ–π, –≥–ª–∞–≤–Ω–æ–µ –Ω–µ 404)

3. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ `–ò–°–ü–†–ê–í–ò–¢–¨-–ö–û–ù–ö–†–ï–¢–ù–´–ô-–ü–õ–ê–¢–ï–ñ.sql` (—Å–º. –≤—ã—à–µ)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ –µ—Å—Ç—å –æ—à–∏–±–∫–∞

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å `üì• –ü–æ–ª—É—á–µ–Ω webhook –æ—Ç –Æ–∫–∞—Å—Å—ã`
- –ï—Å—Ç—å `‚ùå –û—à–∏–±–∫–∞` –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ

**–†–µ—à–µ–Ω–∏–µ:**

1. **–°–º–æ—Ç—Ä–∏–º –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏:**
   ```bash
   docker logs synergy_backend > logs.txt
   ```

2. **–ò—â–µ–º –æ—à–∏–±–∫—É –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ webhook:**
   ```bash
   grep -A 20 "–ü–æ–ª—É—á–µ–Ω webhook" logs.txt | tail -30
   ```

3. **–¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:**
   
   - **"–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"**
     ‚Üí –ü–ª–∞—Ç–µ–∂ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ `/api/payments/create`
     ‚Üí –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   
   - **"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"**
     ‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `user_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
   
   - **"violates check constraint"**
     ‚Üí –í—ã–ø–æ–ª–Ω–∏—Ç–µ:
     ```sql
     ALTER TABLE users DROP CONSTRAINT IF EXISTS users_user_type_check;
     ALTER TABLE users ADD CONSTRAINT users_user_type_check 
     CHECK (user_type IN ('client', 'expert', 'admin'));
     ```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–ª–∞—Ç–µ–∂ –≤ —Å—Ç–∞—Ç—É—Å–µ "pending"

**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –í –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø–ª–∞—Ç–µ–∂ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `status = 'pending'`
- –í –Æ–∫–∞—Å—Å–µ –ø–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–ª–∞—Ç–µ–∂ –≤ –Æ–∫–∞—Å—Å–µ:**
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `yookassa_payment_id` –∏–∑ –±–∞–∑—ã
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ —Å—Ç–∞—Ç—É—Å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–∫–∞—Å—Å—ã

2. **–ï—Å–ª–∏ –≤ –Æ–∫–∞—Å—Å–µ —Å—Ç–∞—Ç—É—Å "succeeded":**
   ```sql
   -- –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
   UPDATE payments 
   SET status = 'succeeded', 
       updated_at = CURRENT_TIMESTAMP 
   WHERE yookassa_payment_id = '–í–°–¢–ê–í–¨–¢–ï_ID_–ò–ó_–Æ–ö–ê–°–°–´';
   
   -- –î–µ–ª–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç–∫—Å–ø–µ—Ä—Ç–æ–º
   UPDATE users u
   SET user_type = 'expert', 
       updated_at = CURRENT_TIMESTAMP
   FROM payments p
   WHERE p.yookassa_payment_id = '–í–°–¢–ê–í–¨–¢–ï_ID_–ò–ó_–Æ–ö–ê–°–°–´'
     AND u.id = p.user_id
     AND p.plan_id IN ('monthly', 'yearly');
   ```

---

## üõ†Ô∏è –ë—ã—Å—Ç—Ä–æ–µ —Ä—É—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (SQL)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Å–¥–µ–ª–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç–∫—Å–ø–µ—Ä—Ç–æ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:

```sql
-- –ó–∞–º–µ–Ω–∏—Ç–µ email –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
UPDATE users 
SET user_type = 'expert', 
    updated_at = CURRENT_TIMESTAMP 
WHERE email = 'user@example.com';

-- –î–æ–±–∞–≤—å—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
INSERT INTO notifications (user_id, type, title, message, created_at)
SELECT 
    id,
    'payment_success',
    '–°—Ç–∞—Ç—É—Å —ç–∫—Å–ø–µ—Ä—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω',
    '–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞. –í—ã —Ç–µ–ø–µ—Ä—å —ç–∫—Å–ø–µ—Ä—Ç!',
    CURRENT_TIMESTAMP
FROM users 
WHERE email = 'user@example.com';

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT email, user_type FROM users WHERE email = 'user@example.com';
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT u.email, u.user_type, p.plan_id, p.status, p.created_at
FROM users u
LEFT JOIN payments p ON p.user_id = u.id
WHERE u.email = 'user@example.com'
ORDER BY p.created_at DESC
LIMIT 1;
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
- `user_type = 'expert'`
- `status = 'succeeded'`
- `plan_id = 'monthly'` –∏–ª–∏ `'yearly'`

---

## üîß –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

### –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend –æ–±–Ω–æ–≤–ª–µ–Ω:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é —Ñ–∞–π–ª–∞:**
   ```bash
   grep -n "expertPlans" backend/src/routes/payments.ts
   ```
   –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ —Å `const expertPlans = ['monthly', 'yearly'];`

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ backend:**
   ```bash
   docker-compose down
   docker-compose up -d --build backend
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:**
   ```bash
   docker logs synergy_backend
   ```
   –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

### –í–∫–ª—é—á–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `docker-compose.yml` –¥–ª—è backend –¥–æ–±–∞–≤—å—Ç–µ:
```yaml
environment:
  - DEBUG=*
  - LOG_LEVEL=debug
```

---

## üìû –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ

1. **–°–æ–±–µ—Ä–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:**
   - –†–µ–∑—É–ª—å—Ç–∞—Ç `–°–†–û–ß–ù–ê–Ø-–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê-–ü–õ–ê–¢–ï–ñ–ê.sql`
   - –ü–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤: `docker logs --tail 200 synergy_backend > logs.txt`
   - –°–∫—Ä–∏–Ω—à–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ webhook –∏–∑ –Æ–∫–∞—Å—Å—ã

2. **–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç `–ò–°–ü–†–ê–í–ò–¢–¨-–ö–û–ù–ö–†–ï–¢–ù–´–ô-–ü–õ–ê–¢–ï–ñ.sql` –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Å–ª—É—á–∞—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —ç–∫—Å–ø–µ—Ä—Ç–∞

3. **–î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è:**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook –æ—Ç –Æ–∫–∞—Å—Å—ã –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞
   - –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å nginx/apache –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è webhook
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall –∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

---

**–°–æ–∑–¥–∞–Ω–æ:** 29 –Ω–æ—è–±—Ä—è 2025  
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~3 –º–∏–Ω—É—Ç—ã  
**–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ


















