import cron from 'node-cron';
import { dailySubscriptionCheck } from '../routes/subscription-checker';

/**
 * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron job –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫
 * 
 * –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 –ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏
 * (–∫–æ–≥–¥–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –º–∏–Ω–∏–º–∞–ª—å–Ω–∞)
 */

let cronJob: cron.ScheduledTask | null = null;

export function startSubscriptionCron(): void {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ cron
  if (cronJob) {
    console.log('‚ö†Ô∏è Cron job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ —É–∂–µ –∑–∞–ø—É—â–µ–Ω');
    return;
  }

  console.log('');
  console.log('‚è∞ ==========================================');
  console.log('‚è∞ –ó–ê–ü–£–°–ö CRON JOB –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–û–ö');
  console.log('‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00');
  console.log('‚è∞ ==========================================');
  console.log('');

  // –ó–∞–ø—É—Å–∫–∞–µ–º cron job: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00
  // –§–æ—Ä–º–∞—Ç: —Å–µ–∫—É–Ω–¥–∞ –º–∏–Ω—É—Ç–∞ —á–∞—Å –¥–µ–Ω—å –º–µ—Å—è—Ü –¥–µ–Ω—å_–Ω–µ–¥–µ–ª–∏
  // 0 0 3 * * * = –≤ 03:00:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
  cronJob = cron.schedule('0 0 3 * * *', async () => {
    try {
      await dailySubscriptionCheck();
    } catch (error) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ cron job –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫:', error);
    }
  }, {
    scheduled: true,
    timezone: "Europe/Moscow" // –£–∫–∞–∂–∏—Ç–µ –≤–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
  });

  console.log('‚úÖ Cron job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ');
  console.log('üìÖ –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: –∑–∞–≤—Ç—Ä–∞ –≤ 03:00');
  console.log('');

  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
  // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–∞–∑—É:
  /*
  console.log('üîÑ –ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞...');
  dailySubscriptionCheck().catch(error => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
  });
  */
}

export function stopSubscriptionCron(): void {
  if (cronJob) {
    cronJob.stop();
    cronJob = null;
    console.log('‚è∞ Cron job –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  }
}

// –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ä—É—á–Ω—É—é
export async function runSubscriptionCheckNow(): Promise<void> {
  console.log('üîÑ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫...');
  try {
    await dailySubscriptionCheck();
    console.log('‚úÖ –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
    throw error;
  }
}

