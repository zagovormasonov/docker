# Исправление: Администратор может создавать события и статьи

## Проблема

Когда пользователя назначали администратором, его `user_type` менялся с `expert` на `admin`. Однако на странице создания событий (`CreateEventPage.tsx`) была проверка, которая разрешала создавать события **только экспертам**, но не администраторам.

### Симптомы:
- ✅ Backend корректно разрешал администраторам создавать события и статьи
- ✅ Кнопки "Создать событие" и "Создать статью" отображались для администраторов
- ❌ При переходе на страницу создания события администратора перенаправляло обратно с ошибкой "Только эксперты могут создавать события"

## Исправление

### Изменённые файлы

**`frontend/src/pages/CreateEventPage.tsx`** (строки 39-42)

**Было:**
```typescript
if (user?.userType !== 'expert') {
  message.error('Только эксперты могут создавать события');
  navigate('/events');
  return;
}
```

**Стало:**
```typescript
if (user?.userType !== 'expert' && user?.userType !== 'admin') {
  message.error('Только эксперты и администраторы могут создавать события');
  navigate('/events');
  return;
}
```

## Проверка других файлов

Были проверены все остальные файлы проекта:

✅ **backend/src/middleware/auth.ts** - middleware `requireExpert` корректно проверяет `'expert'` и `'admin'`  
✅ **frontend/src/components/Header.tsx** - меню корректно показывает пункты для экспертов и администраторов  
✅ **frontend/src/pages/EventsPage.tsx** - кнопка "Создать событие" корректно отображается  
✅ **frontend/src/pages/HomePage.tsx** - кнопка "Создать статью" корректно отображается  
✅ **frontend/src/pages/ProfilePage.tsx** - функции эксперта (галерея, календарь, услуги) корректно отображаются  
✅ **frontend/src/pages/CreateArticlePage.tsx** - нет ограничений по типу пользователя  

## Как это работает сейчас

### Типы пользователей

| Тип | Права |
|-----|-------|
| **client** | Просмотр контента, бронирование, чаты |
| **expert** | Всё выше + создание событий, статей, услуг, управление расписанием |
| **admin** | Всё выше + модерация, управление пользователями, админ-панель |

### Что может администратор:

✅ **Создавать события** - полный доступ к созданию и редактированию  
✅ **Создавать статьи** - полный доступ к созданию и редактированию  
✅ **Создавать услуги** - добавление и управление своими услугами  
✅ **Управлять расписанием** - настройка календаря доступности  
✅ **Управлять галереей** - загрузка и удаление фото  
✅ **Модерировать контент** - одобрение/отклонение событий и статей  
✅ **Управлять пользователями** - назначение экспертов и администраторов  
✅ **Просматривать логи** - история всех действий администраторов  

## Тестирование

### Шаги для проверки:

1. **Войдите как администратор**
2. **Перейдите на страницу "/events"**
3. **Нажмите кнопку "Создать событие"**
4. **Убедитесь, что открылась форма создания события**
5. **Заполните форму и создайте событие**
6. **Проверьте, что событие создано и отправлено на модерацию**

7. **Перейдите на главную страницу**
8. **Нажмите кнопку "Создать статью"**
9. **Убедитесь, что открылась форма создания статьи**
10. **Заполните форму и создайте статью**
11. **Проверьте, что статья создана как черновик**

### Если не работает:

1. **Очистите кэш браузера** (Ctrl+Shift+Delete)
2. **Выйдите из системы и войдите заново** - чтобы обновить токен
3. **Проверьте тип пользователя в профиле** - должно быть "Администратор"
4. **Проверьте консоль браузера** (F12) на наличие ошибок

## SQL-запросы для проверки

### Проверить свой тип пользователя:
```sql
SELECT id, name, email, user_type 
FROM users 
WHERE email = 'ваш_email@example.com';
```

### Проверить всех администраторов:
```sql
SELECT id, name, email, user_type, created_at
FROM users
WHERE user_type = 'admin'
ORDER BY created_at DESC;
```

### Вручную назначить администратора:
```sql
UPDATE users 
SET user_type = 'admin', updated_at = CURRENT_TIMESTAMP
WHERE email = 'ваш_email@example.com';
```

## Важно!

⚠️ **После изменения типа пользователя в базе данных необходимо:**
1. Выйти из системы
2. Войти заново
3. Это обновит JWT токен с новым типом пользователя

⚠️ **Убедитесь, что frontend обновлён:**
```bash
cd frontend
npm install
npm run dev
```

## Техническая информация

### Как работает проверка прав:

1. **На backend** - middleware `requireExpert` проверяет `user_type` в базе данных:
   ```typescript
   if (dbUserType !== 'expert' && dbUserType !== 'admin') {
     return res.status(403).json({ error: 'Доступно только для экспертов' });
   }
   ```

2. **На frontend** - проверка типа из JWT токена:
   ```typescript
   if (user?.userType !== 'expert' && user?.userType !== 'admin') {
     message.error('Только эксперты и администраторы могут создавать события');
     navigate('/events');
   }
   ```

3. **JWT токен** содержит `userType`, который берётся из базы данных при логине

### Почему нужно было исправлять:

- Backend уже был готов и поддерживал администраторов
- Большинство компонентов frontend тоже были готовы
- **Только одна проверка** в `CreateEventPage.tsx` блокировала администраторов
- Эта проверка была избыточна, т.к. backend всё равно проверяет права

## Поддержка

Если возникли проблемы:
1. Проверьте консоль браузера (F12 → Console)
2. Проверьте логи backend
3. Убедитесь, что вы вышли и вошли заново после изменения типа
4. Проверьте в базе данных свой `user_type`

---

**Версия:** 1.0.0  
**Дата:** 27 ноября 2025  
**Автор:** System Administrator

