import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { useAuth } from './AuthContext';
import socketService from '../api/socket';
import api from '../api/axios';
import { message as antMessage } from 'antd';

interface NotificationContextType {
  unreadCount: number;
  playNotificationSound: () => void;
  markAsRead: () => void;
  fetchUnreadCount: () => void;
  testNotification: () => void;
}

const NotificationContext = createContext<NotificationContextType | undefined>(undefined);

export const NotificationProvider = ({ children }: { children: ReactNode }) => {
  const { user } = useAuth();
  const [unreadCount, setUnreadCount] = useState(0);
  
  // ÐŸÑ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð·Ð²ÑƒÐº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
  useEffect(() => {
    const audio = new Audio('/notificate.mp3');
    audio.preload = 'auto';
    audio.load();
    console.log('ðŸ”Š Ð—Ð²ÑƒÐº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð²Ð°Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½');
  }, []);
  
  // Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ð¼ Ð·Ð²ÑƒÐº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°
  const createNotificationSound = () => {
    console.log('ðŸ”Š ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÑÑ‚Ð¸ Ð·Ð²ÑƒÐº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ');
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ñ„Ð°Ð¹Ð»Ð°
    fetch('/notificate.mp3', { method: 'HEAD' })
      .then(response => {
        if (response.ok) {
          console.log('âœ… Ð¤Ð°Ð¹Ð» notificate.mp3 Ð½Ð°Ð¹Ð´ÐµÐ½');
          playAudioFile();
        } else {
          console.error('âŒ Ð¤Ð°Ð¹Ð» notificate.mp3 Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, ÑÑ‚Ð°Ñ‚ÑƒÑ:', response.status);
          playFallbackSound();
        }
      })
      .catch(error => {
        console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°:', error);
        playFallbackSound();
      });
  };

  const playAudioFile = () => {
    const audio = new Audio('/notificate.mp3');
    audio.volume = 0.7;
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
    audio.addEventListener('loadstart', () => console.log('ðŸ”Š ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð·Ð²ÑƒÐºÐ°'));
    audio.addEventListener('canplay', () => console.log('ðŸ”Š Ð—Ð²ÑƒÐº Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸ÑŽ'));
    audio.addEventListener('error', (e) => {
      console.error('ðŸ”Š ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð·Ð²ÑƒÐºÐ°:', e);
      playFallbackSound();
    });
    audio.addEventListener('ended', () => console.log('ðŸ”Š Ð—Ð²ÑƒÐº Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ'));
    
    audio.play().then(() => {
      console.log('âœ… Ð—Ð²ÑƒÐº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾');
    }).catch(error => {
      console.error('âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÑÑ‚Ð¸ Ð·Ð²ÑƒÐº ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ:', error);
      console.log('ðŸ’¡ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð½Ð° fallback Ð·Ð²ÑƒÐº');
      playFallbackSound();
    });
  };

  const playFallbackSound = () => {
    console.log('ðŸ”Š Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ fallback Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð½Ñ‹Ð¹ Ð·Ð²ÑƒÐº');
    try {
      const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      gainNode.gain.value = 0.3;
      
      oscillator.type = 'sine';
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
      
      console.log('âœ… Fallback Ð·Ð²ÑƒÐº Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½');
    } catch (fallbackErr) {
      console.error('âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÑÑ‚Ð¸ Ð´Ð°Ð¶Ðµ fallback Ð·Ð²ÑƒÐº:', fallbackErr);
    }
  };

  useEffect(() => {
    console.log('ðŸ”” NotificationContext: user changed', user);
    
    if (!user) {
      setUnreadCount(0);
      return;
    }

    // Ð¡Ð»ÑƒÑˆÐ°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ‡ÐµÑ€ÐµÐ· Socket.IO
    const handleNewMessage = (message: any) => {
      console.log('ðŸ“¨ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ Ð½Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ:', message);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð¾Ñ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      if (message.sender_id !== user.id) {
        console.log('âœ… ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ');
        
        // ÐœÐ³Ð½Ð¾Ð²ÐµÐ½Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº
        setUnreadCount(prev => prev + 1);
        
        // Ð’Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ð¼ Ð·Ð²ÑƒÐº
        playNotificationSound();
        
        // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification(`ðŸ’¬ ${message.sender_name}`, {
            body: `${message.content.substring(0, 50)}${message.content.length > 50 ? '...' : ''}`,
            icon: '/logo.png',
            tag: `chat-${message.chat_id}`,
            requireInteraction: false,
            silent: false
          });
        }

        // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ant Design ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
        antMessage.info({
          content: `ðŸ’¬ ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ ${message.sender_name}`,
          duration: 4,
          style: {
            marginTop: '20px'
          }
        });
        
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ð¸
        fetchUnreadCount();
      }
    };

    console.log('ðŸ”Œ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº WebSocket Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹');
    socketService.onNewMessage(handleNewMessage);

    return () => {
      console.log('ðŸ”Œ ÐžÑ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð¾Ñ‚ WebSocket');
      socketService.offNewMessage();
    };
  }, [user?.id]); // Ð˜Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ Ð½Ð° user.id Ð²Ð¼ÐµÑÑ‚Ð¾ Ð²ÑÐµÐ³Ð¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ð° user

  // Ð—Ð°Ð¿Ñ€Ð¾Ñ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð½Ð° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
  useEffect(() => {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }, []);

  const playNotificationSound = () => {
    console.log('ðŸ”Š Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ createNotificationSound');
    createNotificationSound();
  };

  const fetchUnreadCount = async () => {
    if (!user) return;
    
    try {
      const response = await api.get('/chats/unread-count');
      setUnreadCount(response.data.count || 0);
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹:', error);
    }
  };

  const markAsRead = async () => {
    setUnreadCount(0);
    // Ð¢Ð°ÐºÐ¶Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
    if (user) {
      try {
        await api.post('/chats/mark-all-read');
      } catch (error) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ…:', error);
      }
    }
  };

  const testNotification = () => {
    console.log('ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ');
    
    // Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð·Ð²ÑƒÐº Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
    console.log('ðŸ”Š ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚ Ð·Ð²ÑƒÐºÐ°...');
    playNotificationSound();
    
    // Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð½Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('ðŸ§ª Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ', {
        body: 'Ð­Ñ‚Ð¾ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹',
        icon: '/logo.png',
        tag: 'test-notification'
      });
    } else {
      console.log('âŒ Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð½Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ñ‹');
    }
    
    // Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ant Design ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
    antMessage.info({
      content: 'ðŸ§ª Ð¢ÐµÑÑ‚Ð¾Ð²Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ',
      duration: 3
    });
    
    // Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº
    setUnreadCount(prev => prev + 1);
  };

  // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  useEffect(() => {
    if (user) {
      fetchUnreadCount();
      
      // ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 ÑÐµÐºÑƒÐ½Ð´ (ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ð»Ð¸ Ñ 30)
      const interval = setInterval(fetchUnreadCount, 10000);
      
      return () => clearInterval(interval);
    }
  }, [user]);

  return (
    <NotificationContext.Provider value={{ unreadCount, playNotificationSound, markAsRead, fetchUnreadCount, testNotification }}>
      {children}
    </NotificationContext.Provider>
  );
};

export const useNotifications = () => {
  const context = useContext(NotificationContext);
  if (!context) {
    throw new Error('useNotifications must be used within NotificationProvider');
  }
  return context;
};

