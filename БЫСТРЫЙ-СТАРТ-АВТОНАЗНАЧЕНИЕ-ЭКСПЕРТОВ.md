# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤

## ‚ö° –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∑–∞ 5 –º–∏–Ω—É—Ç

### 1Ô∏è‚É£ –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ backend (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ ‚úÖ)

–§–∞–π–ª `backend/src/routes/payments.ts` –æ–±–Ω–æ–≤–ª–µ–Ω —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏.

### 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ PostgreSQL:

```bash
psql -d –≤–∞—à–∞_–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö -f FIX-PAYMENTS-AUTO-EXPERT.sql
```

–ò–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `FIX-PAYMENTS-AUTO-EXPERT.sql` –≤ pgAdmin.

**–ß—Ç–æ —ç—Ç–æ –¥–∞—Å—Ç:**
- –ü–æ–∫–∞–∂–µ—Ç –≤—Å–µ —É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í—ã—è–≤–∏—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–ª—É—á–∞–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

### 3Ô∏è‚É£ –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)

–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∑–∞–ª –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `FIX-PAYMENTS-AUTO-EXPERT.sql`
2. –ù–∞–π–¥–∏—Ç–µ –±–ª–æ–∫, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å `/* DO $$` (–ø—Ä–∏–º–µ—Ä–Ω–æ —Å—Ç—Ä–æ–∫–∞ 61)
3. –£–¥–∞–ª–∏—Ç–µ —Å–∏–º–≤–æ–ª—ã `/*` –≤ –Ω–∞—á–∞–ª–µ –∏ `*/` –≤ –∫–æ–Ω—Ü–µ –±–ª–æ–∫–∞
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞

### 4Ô∏è‚É£ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker
docker-compose restart backend

# –ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
cd backend
npm run build
npm start
```

### 5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
# Docker
docker logs -f synergy_backend

# –õ–æ–∫–∞–ª—å–Ω–æ - —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å –≥–¥–µ –∑–∞–ø—É—â–µ–Ω npm start
```

**–û–∂–∏–¥–∞–µ–º–æ–µ –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞:**
```
üì• –ü–æ–ª—É—á–µ–Ω webhook –æ—Ç –Æ–∫–∞—Å—Å—É
‚úÖ –ü–ª–∞–Ω monthly/yearly –¥–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —ç–∫—Å–ø–µ—Ä—Ç–∞
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å user@email.com —É—Å–ø–µ—à–Ω–æ —Å—Ç–∞–ª —ç–∫—Å–ø–µ—Ä—Ç–æ–º
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ SQL:

```sql
-- –ï—Å—Ç—å –ª–∏ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏?
SELECT COUNT(*) as problems
FROM payments p
JOIN users u ON p.user_id = u.id
WHERE p.status = 'succeeded' 
  AND p.plan_id IN ('monthly', 'yearly')
  AND u.user_type != 'expert';
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: **problems = 0**

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
2. –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—á–Ω—É—é –∏–ª–∏ –≥–æ–¥–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É
3. –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π: **5555 5555 5555 4444**
4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ... —Å—Ç–∞–ª —ç–∫—Å–ø–µ—Ä—Ç–æ–º`
   - –í –ø—Ä–æ—Ñ–∏–ª–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–∞—Ç—É—Å "–≠–∫—Å–ø–µ—Ä—Ç"

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –Æ–∫–∞—Å—Å—ã (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)

1. [yookassa.ru](https://yookassa.ru/) ‚Üí –í–æ–π—Ç–∏
2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **Webhook**
3. **URL**: `https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/api/payments/webhook`
4. **–°–æ–±—ã—Ç–∏–µ**: `payment.succeeded` ‚úÖ
5. **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å**

## üìû –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

–°–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é: **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï-–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï-–≠–ö–°–ü–ï–†–¢–û–í.md**

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- ‚úÖ Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –Æ–∫–∞—Å—Å–µ
- ‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –í –±–∞–∑–µ –Ω–µ—Ç constraint –æ—à–∏–±–æ–∫ –¥–ª—è user_type
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ webhook

## üìã –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–Ω–∞**: –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ monthly –∏ yearly –¥–∞—é—Ç —Å—Ç–∞—Ç—É—Å —ç–∫—Å–ø–µ—Ä—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
3. **–û—à–∏–±–∫–∏**: –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
4. **Fallback**: –ï—Å–ª–∏ webhook –Ω–µ –ø—Ä–∏—à–µ–ª, —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞

---

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5 –º–∏–Ω—É—Ç  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:** –î–∞ (—Ç–æ–ª—å–∫–æ backend)









