# üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –æ—Ç –Æ–∫–∞—Å—Å—ã

## üö® –ü–†–û–ë–õ–ï–ú–ê: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ backend

–í–∞—à–∏ –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ webhook –æ—Ç –Æ–∫–∞—Å—Å—ã –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞.
–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `üì• –ü–æ–ª—É—á–µ–Ω webhook –æ—Ç –Æ–∫–∞—Å—Å—ã`, –Ω–æ —ç—Ç–æ–≥–æ –Ω–µ—Ç.

---

## ‚úÖ –®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –Æ–∫–∞—Å—Å–µ

1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç [yookassa.ru](https://yookassa.ru/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** (–∏–ª–∏ **Webhook**)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL webhook

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
```
https://soulsynergy.ru/api/payments/webhook
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–±—ã—Ç–∏—è:
- ‚úÖ `payment.succeeded` - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –í–ö–õ–Æ–ß–ï–ù–û
- ‚úÖ `payment.canceled` - –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å

### –ï—Å–ª–∏ webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:
1. –ù–∞–∂–º–∏—Ç–µ **"–î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"**
2. –í–≤–µ–¥–∏—Ç–µ URL: `https://soulsynergy.ru/api/payments/webhook`
3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ: `payment.succeeded`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

---

## ‚úÖ –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å URL

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

```bash
curl -X POST https://soulsynergy.ru/api/payments/webhook \
  -H "Content-Type: application/json" \
  -d '{"test": "test"}'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: 200 –∏–ª–∏ 400 (–≥–ª–∞–≤–Ω–æ–µ –ù–ï 404 –∏ –ù–ï 502)
- –õ—é–±–æ–π JSON –æ—Ç–≤–µ—Ç

**–ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ 404:**
- Backend –Ω–µ –∑–∞–ø—É—â–µ–Ω
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
- Nginx –Ω–µ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ backend

**–ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ 502/504:**
- Backend —É–ø–∞–ª –∏–ª–∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: `docker ps` - –∑–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä backend

---

## ‚úÖ –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Nginx (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ)

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å Nginx –ø–µ—Ä–µ–¥ backend, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```nginx
location /api/ {
    proxy_pass http://backend:5000/api/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_cache_bypass $http_upgrade;
    
    # –í–ê–ñ–ù–û –¥–ª—è webhook:
    client_max_body_size 10M;
}
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx:
```bash
sudo systemctl reload nginx
# –∏–ª–∏
sudo nginx -s reload
```

---

## ‚úÖ –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Nginx

```bash
# –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞ - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è POST –∑–∞–ø—Ä–æ—Å—ã –æ—Ç –Æ–∫–∞—Å—Å—ã
sudo tail -f /var/log/nginx/access.log | grep webhook

# –õ–æ–≥–∏ –æ—à–∏–±–æ–∫
sudo tail -f /var/log/nginx/error.log
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
- IP –∞–¥—Ä–µ—Å–∞ –Æ–∫–∞—Å—Å—ã (–æ–±—ã—á–Ω–æ –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 185.71.76.0/27, 185.71.77.0/27)
- POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ `/api/payments/webhook`
- –ö–æ–¥—ã –æ—Ç–≤–µ—Ç–∞ (200 = OK, 502 = backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç)

---

## ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend —Å–ª—É—à–∞–µ—Ç webhook

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω
docker ps | grep backend

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
docker logs synergy-backend | head -50
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ:
```
Server is running on port 5000
Connected to database
```

---

## ‚úÖ –®–ê–ì 6: –¢–µ—Å—Ç–æ–≤—ã–π webhook –≤—Ä—É—á–Ω—É—é

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `test-webhook.json`:

```json
{
  "type": "notification",
  "event": "payment.succeeded",
  "object": {
    "id": "test-payment-id-12345",
    "status": "succeeded",
    "amount": {
      "value": "990.00",
      "currency": "RUB"
    },
    "metadata": {
      "payment_id": "999",
      "user_id": "999",
      "plan_id": "yearly"
    }
  }
}
```

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –Ω–∞ –≤–∞—à backend:

```bash
curl -X POST https://soulsynergy.ru/api/payments/webhook \
  -H "Content-Type: application/json" \
  -d @test-webhook.json
```

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend:
```bash
docker logs --tail 50 synergy-backend
```

–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
```
üì• –ü–æ–ª—É—á–µ–Ω webhook –æ—Ç –Æ–∫–∞—Å—Å—ã
üìã –°–æ–±—ã—Ç–∏–µ: payment.succeeded
```

–ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–æ—Å—å - –∑–Ω–∞—á–∏—Ç backend —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –Æ–∫–∞—Å—Å—ã.
–ï—Å–ª–∏ –ù–ï –ø–æ—è–≤–∏–ª–æ—Å—å - –ø—Ä–æ–±–ª–µ–º–∞ –≤ Nginx –∏–ª–∏ —Å–µ—Ç–∏.

---

## ‚úÖ –®–ê–ì 7: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall

```bash
# Ubuntu/Debian
sudo ufw status

# CentOS/RHEL
sudo firewall-cmd --list-all
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç—ã 80 –∏ 443 –æ—Ç–∫—Ä—ã—Ç—ã.

---

## üîß –í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï (–ø–æ–∫–∞ webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —ç–∫—Å–ø–µ—Ä—Ç–æ–≤:

```bash
# –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –≤—ã–ø–æ–ª–Ω—è–π—Ç–µ:
docker exec -i synergy-postgres psql -U postgres -d synergy_db < fix-user-expert-now.sql
```

–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç—É—é –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π.

---

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

```sql
-- –°–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç–µ–∂–µ–π –≤ —Å—Ç–∞—Ç—É—Å–µ pending (–æ–∂–∏–¥–∞—é—Ç webhook)?
SELECT COUNT(*) FROM payments WHERE status = 'pending';

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø–ª–∞—Ç–µ–∂–µ–π
SELECT 
    id, 
    user_id, 
    plan_id, 
    status, 
    yookassa_payment_id,
    created_at 
FROM payments 
ORDER BY created_at DESC 
LIMIT 5;
```

---

## ‚ùì –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "–í –Æ–∫–∞—Å—Å–µ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–∞ Webhook"
**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–¥–µ–ª–µ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" –∏–ª–∏ "HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"

### –ü—Ä–æ–±–ª–µ–º–∞: "–Æ–∫–∞—Å—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ localhost"
**–†–µ—à–µ–Ω–∏–µ:** –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok:
```bash
ngrok http 5000
# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –Æ–∫–∞—Å—Å—ã
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Webhook –ø—Ä–∏—Ö–æ–¥–∏—Ç, –Ω–æ backend –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç"
**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –æ–±–Ω–æ–≤–ª–µ–Ω
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: `docker-compose restart backend`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è YOOKASSA_SECRET_KEY

### –ü—Ä–æ–±–ª–µ–º–∞: "–û—à–∏–±–∫–∞ invalid input syntax for type integer"
**–†–µ—à–µ–Ω–∏–µ:** –≠—Ç–æ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ –∏–∑ articles.js - –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å webhook.
–ù–æ –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å, –µ—Å–ª–∏ –º–µ—à–∞–µ—Ç:
```bash
docker-compose restart backend
```

---

## ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –Æ–∫–∞—Å—Å—ã
- [ ] URL webhook: `https://soulsynergy.ru/api/payments/webhook`
- [ ] –°–æ–±—ã—Ç–∏–µ `payment.succeeded` –≤–∫–ª—é—á–µ–Ω–æ
- [ ] URL –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ curl)
- [ ] Backend –∑–∞–ø—É—â–µ–Ω (`docker ps`)
- [ ] Nginx –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- [ ] Firewall —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π webhook –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ

---

**–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤—Å–µ –Ω–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏!**

–î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `karflawed@gmail.com` –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç.




